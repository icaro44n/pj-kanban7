<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban PCM - Heineken</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- NOVO: SDKs do Firebase -->
    <!-- Adicionamos os scripts do Firebase como módulos -->
    <script type="module">
        // Importa os serviços que vamos usar
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Disponibiliza as funções do Firebase para o nosso script principal
        window.firebaseSDK = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, collection, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, setLogLevel
        };
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .sortable-ghost { opacity: 0.3; background: #dbeafe; border: 2px dashed #60a5fa; }
        .sortable-chosen { cursor: grabbing; opacity: 0.9; transform: scale(1.02); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .kanban-column-body { max-height: 75vh; overflow-y: auto; }
        .kanban-column-body::-webkit-scrollbar { width: 8px; }
        .kanban-column-body::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .kanban-column-body::-webkit-scrollbar-thumb { background: #bbf7d0; border-radius: 10px; }
        .kanban-column-body::-webkit-scrollbar-thumb:hover { background: #86efac; }
        input[type=number] { -moz-appearance: textfield; }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="antialiased text-gray-900">

    <!-- Cabeçalho (Tema Heineken PCM) -->
    <header class="bg-green-800 text-white shadow-lg sticky top-0 z-40">
        <!-- ... (Conteúdo do cabeçalho não modificado) ... -->
        <div class="container mx-auto max-w-full px-4 md:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 text-green-300">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12a7.5 7.5 0 0 0 15 0m-15 0a7.5 7.5 0 1 1 15 0m-15 0H3m18 0h-1.5m-15 0H3m18 0h-1.5m-15 0H3m18 0h-1.5M12 4.5v.008v.008H12V4.5Zm0 15v.008v.008H12V19.5Zm0-7.5v.008v.008H12v-.008Zm0 0h.008v.008H12v-.008Zm-3.75 3.75h.008v.008h-.008v-.008Zm0-7.5h.008v.008h-.008V8.25Zm7.5 0h.008v.008h-.008V8.25Zm0 7.5h.008v.008h-.008v-.008Z" />
                </svg>
                <div>
                    <h1 class="text-2xl font-bold">Kanban PCM</h1>
                    <p class="text-sm text-gray-200 font-light">Cervejaria Heineken</p>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <button id="filter-priority-btn" class="relative hidden md:flex items-center space-x-2 bg-green-700 hover:bg-green-600 px-4 py-2 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2 focus:ring-offset-green-800">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-300">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 7.5 7.5 3m0 0L12 7.5M7.5 3v13.5m13.5 0L16.5 21m0 0L12 16.5m4.5 4.5V7.5" />
                    </svg>
                    <span class="text-sm font-medium">Prioridade</span>
                </button>
                <button id="filter-owner-btn" title="Filtro de Responsável (Em breve)" class="hidden md:flex items-center space-x-2 bg-green-700 hover:bg-green-600 px-4 py-2 rounded-lg transition-colors duration-200 opacity-70 cursor-not-allowed">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-300">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A1.5 1.5 0 0 1 18 21.75H6a1.5 1.5 0 0 1-1.499-1.632Z" />
                    </svg>
                    <span class="text-sm font-medium">Responsável</span>
                </button>
                <button id="add-task-btn" class="bg-green-600 hover:bg-green-700 px-5 py-2 rounded-lg font-semibold shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2 focus:ring-offset-green-800">
                    Adicionar OS
                </button>
            </div>
        </div>
    </header>

    <!-- Indicador de Status de Login e Banco de Dados -->
    <div id="auth-status" class="py-2 px-6 bg-green-900 text-green-200 text-sm text-center sticky top-[80px] z-30">
        Conectando ao banco de dados...
    </div>

    <!-- Menu Pop-up de Filtro de Prioridade -->
    <div id="priority-filter-menu" class="hidden absolute top-[75px] right-[100px] md:right-[260px] bg-white text-gray-800 rounded-lg shadow-xl z-50 p-3 w-48 border border-gray-200">
        <!-- ... (Conteúdo do menu de filtro não modificado) ... -->
        <p class="text-sm font-semibold mb-2 px-2 text-gray-600">Filtrar por Prioridade:</p>
        <button data-priority="all" class="filter-option-btn w-full text-left px-3 py-1.5 rounded-md hover:bg-gray-100 font-medium">Todos</button>
        <button data-priority="high" class="filter-option-btn w-full text-left px-3 py-1.5 rounded-md hover:bg-gray-100 flex items-center font-medium"><span class="w-3 h-3 bg-red-500 rounded-full mr-2.5 flex-shrink-0"></span>Alta</button>
        <button data-priority="medium" class="filter-option-btn w-full text-left px-3 py-1.5 rounded-md hover:bg-gray-100 flex items-center font-medium"><span class="w-3 h-3 bg-orange-500 rounded-full mr-2.5 flex-shrink-0"></span>Média</button>
        <button data-priority="low" class="filter-option-btn w-full text-left px-3 py-1.5 rounded-md hover:bg-gray-100 flex items-center font-medium"><span class="w-3 h-3 bg-blue-500 rounded-full mr-2.5 flex-shrink-0"></span>Baixa</button>
    </div>


    <!-- Board Container -->
    <main id="kanban-board" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6 p-6">
        
        <!-- Coluna 1: Solicitações / Backlog -->
        <div class="kanban-column bg-white rounded-xl shadow-lg flex flex-col">
            <!-- CABEÇALHO DA COLUNA ATUALIZADO -->
            <div class="p-4 border-b border-gray-200 flex justify-between items-center sticky top-[124px] bg-white rounded-t-xl z-10">
                <div class="flex items-center space-x-3">
                    <span class="w-3 h-3 bg-red-500 rounded-full flex-shrink-0"></span>
                    <h3 class="font-semibold text-gray-800 uppercase text-sm tracking-wider">Solicitações / Backlog</h3>
                </div>
                <span id="count-col-restaurar" class="px-2.5 py-0.5 bg-gray-200 text-gray-700 rounded-full font-semibold text-xs">0</span>
            </div>
            <div id="col-restaurar" class="p-4 space-y-4 kanban-column-body flex-grow min-h-[200px]" data-column-id="col-restaurar"></div>
        </div>
        
        <!-- Coluna 2: Planejamento / Aguard. Peças -->
        <div class="kanban-column bg-white rounded-xl shadow-lg flex flex-col">
            <!-- CABEÇALHO DA COLUNA ATUALIZADO -->
            <div class="p-4 border-b border-gray-200 flex justify-between items-center sticky top-[124px] bg-white rounded-t-xl z-10">
                <div class="flex items-center space-x-3">
                    <span class="w-3 h-3 bg-yellow-500 rounded-full flex-shrink-0"></span>
                    <h3 class="font-semibold text-gray-800 uppercase text-sm tracking-wider">Planejamento / Aguard. Peças</h3>
                </div>
                <span id="count-col-diagnostico" class="px-2.5 py-0.5 bg-gray-200 text-gray-700 rounded-full font-semibold text-xs">0</span>
            </div>
            <div id="col-diagnostico" class="p-4 space-y-4 kanban-column-body flex-grow min-h-[200px]" data-column-id="col-diagnostico"></div>
        </div>

        <!-- Coluna 3: Programado -->
        <div class="kanban-column bg-white rounded-xl shadow-lg flex flex-col">
            <!-- CABEÇALHO DA COLUNA ATUALIZADO -->
            <div class="p-4 border-b border-gray-200 flex justify-between items-center sticky top-[124px] bg-white rounded-t-xl z-10">
                <div class="flex items-center space-x-3">
                    <span class="w-3 h-3 bg-orange-500 rounded-full flex-shrink-0"></span>
                    <h3 class="font-semibold text-gray-800 uppercase text-sm tracking-wider">Programado</h3>
                </div>
                <span id="count-col-restauracao" class="px-2.5 py-0.5 bg-gray-200 text-gray-700 rounded-full font-semibold text-xs">0</span>
            </div>
            <div id="col-restauracao" class="p-4 space-y-4 kanban-column-body flex-grow min-h-[200px]" data-column-id="col-restauracao"></div>
        </div>

        <!-- Coluna 4: Em Execução -->
        <div class="kanban-column bg-white rounded-xl shadow-lg flex flex-col">
            <!-- CABEÇALHO DA COLUNA ATUALIZADO -->
            <div class="p-4 border-b border-gray-200 flex justify-between items-center sticky top-[124px] bg-white rounded-t-xl z-10">
                <div class="flex items-center space-x-3">
                    <span class="w-3 h-3 bg-blue-500 rounded-full flex-shrink-0"></span>
                    <h3 class="font-semibold text-gray-800 uppercase text-sm tracking-wider">Em Execução</h3>
                </div>
                <span id="count-col-teste" class="px-2.5 py-0.5 bg-gray-200 text-gray-700 rounded-full font-semibold text-xs">0</span>
            </div>
            <div id="col-teste" class="p-4 space-y-4 kanban-column-body flex-grow min-h-[200px]" data-column-id="col-teste"></div>
        </div>

        <!-- Coluna 5: Concluído / Verificação -->
        <div class="kanban-column bg-white rounded-xl shadow-lg flex flex-col">
            <!-- CABEÇALHO DA COLUNA ATUALIZADO -->
            <div class="p-4 border-b border-gray-200 flex justify-between items-center sticky top-[124px] bg-white rounded-t-xl z-10">
                <div class="flex items-center space-x-3">
                    <span class="w-3 h-3 bg-green-500 rounded-full flex-shrink-0"></span>
                    <h3 class="font-semibold text-gray-800 uppercase text-sm tracking-wider">Concluído / Verificação</h3>
                </div>
                <span id="count-col-pronto" class="px-2.5 py-0.5 bg-gray-200 text-gray-700 rounded-full font-semibold text-xs">0</span>
            </div>
            <div id="col-pronto" class="p-4 space-y-4 kanban-column-body flex-grow min-h-[200px]" data-column-id="col-pronto"></div>
        </div>
    </main>

    <!-- Modais (HTML não modificado) -->
    <!-- Modal de Adicionar/Editar Ordem de Serviço -->
    <div id="task-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 hidden transition-opacity duration-300">
        <div class="bg-white rounded-lg shadow-2xl max-w-lg w-full transform transition-all scale-95 opacity-0" id="task-modal-content">
            <form id="task-form">
                <div class="flex justify-between items-center p-5 border-b border-gray-200">
                    <h4 id="modal-title" class="text-2xl font-semibold text-gray-800">Adicionar Ordem de Serviço</h4>
                    <button type="button" id="close-modal-btn" class="text-gray-400 hover:text-gray-600" aria-label="Fechar modal">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="p-6 space-y-5">
                    <div>
                        <label for="task-id-input" class="block text-sm font-medium text-gray-700 mb-1">Nº da OS / SM (Obrigatório)</label>
                        <input type="text" id="task-id-input" placeholder="Ex: OS-45102" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        <p id="task-id-display" class="text-lg font-medium text-gray-600 hidden"></p>
                    </div>
                    <div>
                        <label for="task-text-input" class="block text-sm font-medium text-gray-700 mb-1">Descrição do Serviço <span class="text-red-500">*</span></label>
                        <textarea id="task-text-input" rows="4" placeholder="Descreva o serviço de manutenção..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required></textarea>
                    </div>
                    <div>
                        <label for="task-priority-input" class="block text-sm font-medium text-gray-700 mb-1">Prioridade</label>
                        <select id="task-priority-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-green-500">
                            <option value="low">Baixa</option>
                            <option value="medium" selected>Média</option>
                            <option value="high">Alta</option>
                        </select>
                    </div>
                    <input type="hidden" id="task-id-hidden">
                    <p id="modal-error-message" class="text-red-500 text-sm"></p>
                </div>
                <div class="flex justify-end items-center space-x-4 p-5 bg-gray-50 rounded-b-lg">
                    <button type="button" id="cancel-modal-btn" class="px-5 py-2 rounded-lg bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" id="save-task-btn" class="px-6 py-2 rounded-lg bg-green-600 text-white font-semibold hover:bg-green-700 transition-colors shadow-md">
                        Salvar Ordem
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Confirmação de Exclusão -->
    <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 hidden transition-opacity duration-300">
         <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full mx-4 transform transition-all scale-95 opacity-0" id="delete-modal-content">
            <h4 class="text-xl font-semibold mb-4 text-gray-800">Confirmar Encerramento</h4>
            <p class="text-gray-600 mb-6">Tem certeza de que deseja encerrar esta OS?</p>
            <div class="flex justify-end space-x-3">
                <button id="cancel-delete-btn" class="px-5 py-2 rounded-lg bg-gray-300 text-gray-800 hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-400 transition-colors">
                    Cancelar
                </button>
                <button id="confirm-delete-btn" class="px-5 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors">
                    Encerrar OS
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        // Aguarda o DOM estar pronto e o SDK do Firebase estar carregado
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- Variáveis Globais do App ---
            
            // Colunas
            const columns = {
                "col-restaurar": document.getElementById('col-restaurar'),
                "col-diagnostico": document.getElementById('col-diagnostico'),
                "col-restauracao": document.getElementById('col-restauracao'),
                "col-teste": document.getElementById('col-teste'),
                "col-pronto": document.getElementById('col-pronto')
            };
            const columnIds = Object.keys(columns);

            // Botões e Modais
            const addTaskBtn = document.getElementById('add-task-btn');
            const taskModal = document.getElementById('task-modal');
            const taskModalContent = document.getElementById('task-modal-content');
            const taskForm = document.getElementById('task-form');
            const modalTitle = document.getElementById('modal-title');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const cancelModalBtn = document.getElementById('cancel-modal-btn');
            const saveTaskBtn = document.getElementById('save-task-btn');
            const taskIdInput = document.getElementById('task-id-input');
            const taskIdDisplay = document.getElementById('task-id-display');
            const taskTextInput = document.getElementById('task-text-input');
            const taskPriorityInput = document.getElementById('task-priority-input');
            const taskIdHidden = document.getElementById('task-id-hidden');
            const modalErrorMessage = document.getElementById('modal-error-message');
            const deleteModal = document.getElementById('delete-modal');
            const deleteModalContent = document.getElementById('delete-modal-content');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const filterPriorityBtn = document.getElementById('filter-priority-btn');
            const priorityFilterMenu = document.getElementById('priority-filter-menu');
            const authStatus = document.getElementById('auth-status');

            // --- Variáveis de Estado e Firebase ---
            let state = { tasks: {} }; // Cache local dos dados do Firebase
            let taskToDeleteId = null;
            let activePriorityFilter = 'all';
            
            let db = null; // Instância do Firestore
            let auth = null; // Instância do Auth
            let tasksCollectionRef = null; // Referência da coleção
            let unsubscribeFromTasks = null; // Função para parar de ouvir o listener
            
            // --- Funções de UI (Modais) ---
            
            const getPriorityClasses = (priority) => {
                switch (priority) {
                    case 'high': return { border: 'border-red-500', text: 'Alta', bg: 'bg-red-500' };
                    case 'medium': return { border: 'border-orange-500', text: 'Média', bg: 'bg-orange-500' };
                    case 'low': return { border: 'border-blue-500', text: 'Baixa', bg: 'bg-blue-500' };
                    default: return { border: 'border-gray-400', text: 'N/A', bg: 'bg-gray-400' };
                }
            };

            const showModal = (modalElement, contentElement) => {
                modalElement.classList.remove('hidden');
                setTimeout(() => {
                    modalElement.classList.add('opacity-100');
                    contentElement.classList.add('scale-100', 'opacity-100');
                    contentElement.classList.remove('scale-95', 'opacity-0');
                }, 10);
            };

            const hideModal = (modalElement, contentElement) => {
                contentElement.classList.remove('scale-100', 'opacity-100');
                contentElement.classList.add('scale-95', 'opacity-0');
                modalElement.classList.remove('opacity-100');
                setTimeout(() => {
                    modalElement.classList.add('hidden');
                }, 200); 
            };

            const openTaskModal = (mode = 'add', taskId = null) => {
                modalErrorMessage.textContent = '';
                taskForm.reset();
                taskPriorityInput.value = 'medium'; 
                
                if (mode === 'add') {
                    modalTitle.textContent = 'Adicionar Nova Ordem de Serviço';
                    taskIdHidden.value = '';
                    taskIdInput.value = `OS-${Math.floor(10000 + Math.random() * 90000)}`; 
                    taskIdInput.classList.remove('hidden');
                    taskIdDisplay.classList.add('hidden');
                    saveTaskBtn.textContent = 'Adicionar Ordem';
                } else if (mode === 'edit' && taskId) {
                    const task = state.tasks[taskId];
                    if (!task) return;
                    
                    modalTitle.textContent = 'Editar Ordem de Serviço';
                    taskIdHidden.value = taskId;
                    taskIdInput.classList.add('hidden');
                    taskIdDisplay.textContent = `OS: ${task.id}`;
                    taskIdDisplay.classList.remove('hidden');
                    taskTextInput.value = task.text;
                    taskPriorityInput.value = task.priority;
                    saveTaskBtn.textContent = 'Salvar Alterações';
                }
                showModal(taskModal, taskModalContent);
                taskTextInput.focus();
            };

            const closeTaskModal = () => hideModal(taskModal, taskModalContent);
            const showDeleteModal = (taskId) => {
                taskToDeleteId = taskId;
                showModal(deleteModal, deleteModalContent);
            };
            const hideDeleteModal = () => {
                hideModal(deleteModal, deleteModalContent);
                taskToDeleteId = null;
            };

            // --- Funções do Board (Renderização) ---

            const createTaskElement = (task) => {
                const priority = getPriorityClasses(task.priority);
                
                const sanitizedId = DOMPurify.sanitize(task.id);
                const sanitizedText = DOMPurify.sanitize(task.text);
                
                const card = document.createElement('div');
                card.className = `task-card bg-white p-4 rounded-lg shadow-md border-l-4 ${priority.border} cursor-move hover:shadow-lg transition-all duration-200 group relative`;
                card.dataset.taskId = task.id;
                
                card.innerHTML = `
                    <p class="text-sm font-semibold text-gray-500">${sanitizedId}</p>
                    <p class="text-gray-800 mt-1.5 font-medium">${sanitizedText}</p>
                    <div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-100">
                        <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${priority.bg} text-white">${priority.text}</span>
                    </div>
                    <button class="delete-task-btn absolute top-2 right-2 text-gray-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity" aria-label="Encerrar OS">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12.5 0c-.342.052-.682.107-1.022.166m1.022-.165L5.84 19.673a2.25 2.25 0 0 0 2.244 2.077H15.916a2.25 2.25 0 0 0 2.244-2.077L19.228 5.79m-14.456 0a48.108 48.108 0 0 1 3.478-.397m12.5 0c.342.052.682.107 1.022.166" />
                        </svg>
                    </button>
                `;

                card.addEventListener('click', () => openTaskModal('edit', task.id));
                card.querySelector('.delete-task-btn').addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    showDeleteModal(task.id);
                });
                return card;
            };

            // FUNÇÃO RENDER ATUALIZADA
            const renderBoard = () => {
                // Limpa colunas
                columnIds.forEach(colId => { columns[colId].innerHTML = ''; });

                // Filtra tarefas
                const tasksToRender = Object.values(state.tasks).filter(task => {
                    if (activePriorityFilter === 'all') return true; 
                    return task.priority === activePriorityFilter;
                });

                // NOVO: Inicializa contadores
                const columnCounts = {
                    "col-restaurar": 0,
                    "col-diagnostico": 0,
                    "col-restauracao": 0,
                    "col-teste": 0,
                    "col-pronto": 0
                };

                // Adiciona tarefas e incrementa contadores
                tasksToRender.forEach(task => {
                    if (columns[task.column]) {
                        columnCounts[task.column]++; // Incrementa o contador da coluna
                        columns[task.column].appendChild(createTaskElement(task));
                    }
                });

                // NOVO: Atualiza o DOM dos contadores
                document.getElementById('count-col-restaurar').textContent = columnCounts['col-restaurar'];
                document.getElementById('count-col-diagnostico').textContent = columnCounts['col-diagnostico'];
                document.getElementById('count-col-restauracao').textContent = columnCounts['col-restauracao'];
                document.getElementById('count-col-teste').textContent = columnCounts['col-teste'];
                document.getElementById('count-col-pronto').textContent = columnCounts['col-pronto'];

                // Atualiza aparência do botão de filtro
                if (activePriorityFilter === 'all') {
                    filterPriorityBtn.classList.remove('bg-green-500', 'ring-2', 'ring-green-300', 'ring-offset-green-800');
                    filterPriorityBtn.classList.add('bg-green-700');
                } else {
                    filterPriorityBtn.classList.add('bg-green-500', 'ring-2', 'ring-green-300', 'ring-offset-green-800');
                    filterPriorityBtn.classList.remove('bg-green-700');
                }
            };
            
            // --- Funções de Lógica de Dados (AGORA COM FIREBASE) ---
            
            // Importa as funções do Firebase que carregamos no window
            const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
                    getFirestore, collection, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, setLogLevel
            } = window.firebaseSDK;

            // ADICIONAR/EDITAR OS
            const handleTaskFormSubmit = async (e) => {
                e.preventDefault();
                modalErrorMessage.textContent = '';
                if (!db) return; // Proteção para caso o DB não esteja pronto

                const text = taskTextInput.value.trim();
                const priority = taskPriorityInput.value;
                const editingId = taskIdHidden.value;
                
                if (!text) {
                    modalErrorMessage.textContent = 'A descrição do serviço é obrigatória.';
                    return;
                }
                
                try {
                    if (editingId) {
                        // --- Modo Edição (Update) ---
                        const taskRef = doc(db, tasksCollectionRef.path, editingId);
                        await updateDoc(taskRef, {
                            text: text,
                            priority: priority
                        });
                    } else {
                        // --- Modo Adição (Set) ---
                        const id = taskIdInput.value.trim();
                        if (!id) {
                            modalErrorMessage.textContent = 'O Nº da OS/SM é obrigatório.';
                            return;
                        }
                        // Verifica se o ID já existe
                        const docRef = doc(db, tasksCollectionRef.path, id);
                        const docSnap = await getDoc(docRef); // Esta linha causava o erro
                        if (docSnap.exists()) {
                             modalErrorMessage.textContent = 'Este número de OS/SM já existe.';
                             return;
                        }
                        
                        const newTask = {
                            id: id,
                            text: text,
                            priority: priority,
                            column: 'col-restaurar'
                        };
                        await setDoc(docRef, newTask);
                    }
                    // Não precisamos mais chamar saveState() ou renderBoard()
                    // O onSnapshot vai detetar a mudança e re-renderizar
                    closeTaskModal();
                } catch (error) {
                    console.error("Erro ao salvar OS:", error);
                    modalErrorMessage.textContent = "Erro ao salvar no banco de dados.";
                }
            };

            // DELETAR OS
            const handleConfirmDelete = async () => {
                if (taskToDeleteId && db) {
                    try {
                        const taskRef = doc(db, tasksCollectionRef.path, taskToDeleteId);
                        await deleteDoc(taskRef);
                        // onSnapshot vai cuidar da re-renderização
                    } catch (error) {
                         console.error("Erro ao deletar OS:", error);
                    }
                }
                hideDeleteModal();
            };

            // INICIALIZAR DRAG-AND-DROP (COM FIREBASE)
            const initSortable = () => {
                columnIds.forEach(colId => {
                    new Sortable(columns[colId], {
                        group: 'kanban',
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        chosenClass: 'sortable-chosen',
                        onEnd: async (evt) => { // A função agora é async
                            const taskId = evt.item.dataset.taskId;
                            const newColumnId = evt.to.dataset.columnId;

                            if (state.tasks[taskId] && state.tasks[taskId].column !== newColumnId) {
                                // Atualiza o cache local (para UI rápida)
                                state.tasks[taskId].column = newColumnId; 
                                
                                // Atualiza no Firebase
                                try {
                                    const taskRef = doc(db, tasksCollectionRef.path, taskId);
                                    await updateDoc(taskRef, {
                                        column: newColumnId
                                    });
                                } catch(error) {
                                    console.error("Erro ao mover card:", error);
                                    // Se der erro, re-renderiza para voltar ao estado original
                                    renderBoard(); 
                                }
                            }
                        }
                    });
                });
            };

            // --- Função Principal (Inicialização do Firebase) ---
            
            async function main() {
                // --- 1. Configuração do Firebase ---
                
                // Variáveis de ambiente (injeção automática)
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'kanban-pcm-heineken-default';
                const collectionPath = `/artifacts/${appId}/public/data/tasks`;
                
                // Tenta carregar a config do ambiente
                let firebaseConfigJson = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
                
                // *************** SUA VEZ ***************
                // Se a config do ambiente não existir, use esta de fallback
                // COLE O SEU OBJETO `firebaseConfig` AQUI:
                const fallbackConfig = {
                    apiKey: "COLE_SUA_API_KEY_AQUI",
                    authDomain: "SEU_PROJETO_ID.firebaseapp.com",
                    projectId: "SEU_PROJETO_ID",
                    storageBucket: "SEU_PROJETO_ID.appspot.com",
                    messagingSenderId: "SEU_SENDER_ID",
                    appId: "SEU_APP_ID"
                };
                // ***************************************

                let firebaseConfig;
                try {
                     firebaseConfig = JSON.parse(firebaseConfigJson);
                     if (!firebaseConfig.apiKey) throw new Error("Config do ambiente vazia");
                } catch(e) {
                    console.warn("Usando config de fallback. Cole a sua config do Firebase.");
                    firebaseConfig = fallbackConfig;
                }

                if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("COLE_SUA_API_KEY")) {
                    authStatus.textContent = "Erro: Configuração do Firebase não encontrada. Cole seu 'firebaseConfig' no script.";
                    authStatus.classList.add('bg-red-700');
                    return;
                }
                
                // Inicializa o Firebase
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    setLogLevel('Debug'); // Mostra logs detalhados do Firebase
                } catch (error) {
                    console.error("Erro ao inicializar Firebase:", error);
                    authStatus.textContent = "Erro fatal ao conectar ao Firebase.";
                    return;
                }

                // --- 2. Anexar Listeners de UI ---
                // (Isso pode ser feito antes do login)
                addTaskBtn.addEventListener('click', () => openTaskModal('add'));
                closeModalBtn.addEventListener('click', closeTaskModal);
                cancelModalBtn.addEventListener('click', closeTaskModal);
                taskForm.addEventListener('submit', handleTaskFormSubmit);
                
                cancelDeleteBtn.addEventListener('click', hideDeleteModal);
                confirmDeleteBtn.addEventListener('click', handleConfirmDelete);

                taskModal.addEventListener('click', (e) => { if (e.target === taskModal) closeTaskModal(); });
                deleteModal.addEventListener('click', (e) => { if (e.target === deleteModal) hideDeleteModal(); });
                
                filterPriorityBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    priorityFilterMenu.classList.toggle('hidden');
                });
                priorityFilterMenu.querySelectorAll('.filter-option-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        activePriorityFilter = btn.dataset.priority;
                        priorityFilterMenu.classList.add('hidden');
                        renderBoard(); // Filtra o cache local
                    });
                });
                document.addEventListener('click', (e) => {
                    if (!priorityFilterMenu.classList.contains('hidden') && !priorityFilterMenu.contains(e.target) && e.target !== filterPriorityBtn && !filterPriorityBtn.contains(e.target)) {
                        priorityFilterMenu.classList.add('hidden');
                    }
                });

                // --- 3. Autenticação e Carregamento de Dados ---
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // Usuário está logado
                        const userId = user.uid;
                        authStatus.textContent = `Conectado (Usuário: ${userId.substring(0, 8)}...). Sincronizando...`;
                        
                        // Inicia o listener do banco de dados
                        tasksCollectionRef = collection(db, collectionPath);
                
                        if (unsubscribeFromTasks) unsubscribeFromTasks(); // Limpa listener antigo

                        // O onSnapshot é o "coração" do app em tempo real
                        unsubscribeFromTasks = onSnapshot(tasksCollectionRef, (snapshot) => {
                            const newTasks = {};
                            snapshot.forEach((doc) => {
                                newTasks[doc.id] = { ...doc.data(), id: doc.id };
                            });
                            
                            state.tasks = newTasks; // Atualiza o cache local
                            renderBoard(); // Re-desenha o board com os novos dados
                            authStatus.textContent = `Conectado (Usuário: ${userId.substring(0, 8)}...). Sincronizado.`;
                        }, (error) => {
                            console.error("Erro ao ouvir o banco de dados:", error);
                            authStatus.textContent = "Erro de conexão com o banco de dados.";
                        });

                        // Inicializa o Drag-and-Drop
                        initSortable();

                    } else {
                        // Usuário não está logado
                        if (unsubscribeFromTasks) unsubscribeFromTasks();
                        state.tasks = {};
                        renderBoard();
                        authStatus.textContent = "Autenticando...";
                    }
                });

                // Tenta fazer o login
                try {
                    const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if (authToken) {
                        await signInWithCustomToken(auth, authToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Erro na autenticação:", error);
                    authStatus.textContent = "Erro de autenticação. Verifique as regras do Firebase.";
                }
            }

            // Inicia a aplicação
            main();
        });
    </script>
</body>
</html>